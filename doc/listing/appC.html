<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<title>app.c</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<style type="text/css">
<!--
body {color: #000000; background-color: #ffffff; font-family: Monospaced}
pre {color: #000000; background-color: #ffffff; font-family: Monospaced}
table {color: #000000; background-color: #e9e8e2; font-family: Monospaced}
.preprocessor {color: #009b00}
.ST2 {font-family: Monospaced; font-weight: bold}
.comment {color: #748ab0}
.ST1 {color: #9933cc}
.literal {color: #0a0a7c}
.ST3 {color: #989800}
.pragma-omp-keyword-directive {color: #2e92c7}
.string {color: #cc7800}
.ST0 {color: #748ab0; background-color: #f1f1da}
.ST4 {background-color: #eceba3}
-->
</style>
</head>
<body>
<table width="100%"><tr><td align="center">C:\microchip\harmony\v2_06\apps\PROJ\Code-Principale\firmware\src\app.c</td></tr></table>
<pre>
  1 <span class="ST0">/**</span><span class="ST0">*****************************************************************************</span>
  2   <span class="comment">MPLAB</span> <span class="comment">Harmony</span> <span class="comment">Application</span> <span class="comment">Source</span> <span class="comment">File</span>
  3   
  4   <span class="comment">Company</span><span class="comment">:</span>
  5     <span class="comment">Microchip</span> <span class="comment">Technology</span> <span class="comment">Inc</span><span class="comment">.</span>
  6   
  7   <span class="comment">File</span> <span class="comment">Name</span><span class="comment">:</span>
  8     <span class="comment">app</span><span class="comment">.</span><span class="comment">c</span>
  9 
 10   <span class="comment">Summary</span><span class="comment">:</span>
 11     <span class="comment">This</span> <span class="comment">file</span> <span class="comment">contains</span> <span class="comment">the</span> <span class="comment">source</span> <span class="comment">code</span> <span class="comment">for</span> <span class="comment">the</span> <span class="comment">MPLAB</span> <span class="comment">Harmony</span> <span class="comment">application</span><span class="comment">.</span>
 12 
 13   <span class="comment">Description</span><span class="comment">:</span>
 14     <span class="comment">This</span> <span class="comment">file</span> <span class="comment">contains</span> <span class="comment">the</span> <span class="comment">source</span> <span class="comment">code</span> <span class="comment">for</span> <span class="comment">the</span> <span class="comment">MPLAB</span> <span class="comment">Harmony</span> <span class="comment">application</span><span class="comment">.</span>  <span class="comment">It</span> 
 15     <span class="comment">implements</span> <span class="comment">the</span> <span class="comment">logic</span> <span class="comment">of</span> <span class="comment">the</span> <span class="comment">application</span><span class="comment">&#39;</span><span class="comment">s</span> <span class="comment">state</span> <span class="comment">machine</span> <span class="comment">and</span> <span class="comment">it</span> <span class="comment">may</span> <span class="comment">call</span> 
 16     <span class="comment">API</span> <span class="comment">routines</span> <span class="comment">of</span> <span class="comment">other</span> <span class="comment">MPLAB</span> <span class="comment">Harmony</span> <span class="comment">modules</span> <span class="comment">in</span> <span class="comment">the</span> <span class="comment">system</span><span class="comment">, </span><span class="comment">such</span> <span class="comment">as</span> <span class="comment">drivers</span><span class="comment">,</span>
 17     <span class="comment">system</span> <span class="comment">services</span><span class="comment">, </span><span class="comment">and</span> <span class="comment">middleware</span><span class="comment">.</span>  <span class="comment">However</span><span class="comment">, </span><span class="comment">it</span> <span class="comment">does</span> <span class="comment">not</span> <span class="comment">call</span> <span class="comment">any</span> <span class="comment">of</span> <span class="comment">the</span>
 18     <span class="comment">system</span> <span class="comment">interfaces</span><span class="comment"> (</span><span class="comment">such</span> <span class="comment">as</span> <span class="comment">the</span><span class="comment"> &quot;</span><span class="comment">Initialize</span><span class="comment">&quot; </span><span class="comment">and</span><span class="comment"> &quot;</span><span class="comment">Tasks</span><span class="comment">&quot; </span><span class="comment">functions</span><span class="comment">) </span><span class="comment">of</span> <span class="comment">any</span> <span class="comment">of</span>
 19     <span class="comment">the</span> <span class="comment">modules</span> <span class="comment">in</span> <span class="comment">the</span> <span class="comment">system</span> <span class="comment">or</span> <span class="comment">make</span> <span class="comment">any</span> <span class="comment">assumptions</span> <span class="comment">about</span> <span class="comment">when</span> <span class="comment">those</span> <span class="comment">functions</span>
 20     <span class="comment">are</span> <span class="comment">called</span><span class="comment">.</span>  <span class="comment">That</span> <span class="comment">is</span> <span class="comment">the</span> <span class="comment">responsibility</span> <span class="comment">of</span> <span class="comment">the</span> <span class="comment">configuration</span><span class="comment">-</span><span class="comment">specific</span> <span class="comment">system</span>
 21     <span class="comment">files</span><span class="comment">.</span>
 22  <span class="comment">******************************************************************************</span><span class="comment">*/</span>
 23 
 24 <span class="comment">//</span> <span class="comment">DOM</span><span class="comment">-</span><span class="comment">IGNORE</span><span class="comment">-</span><span class="comment">BEGIN</span>
 25 <span class="comment">/**</span><span class="comment">*****************************************************************************</span>
 26 <span class="comment">Copyright</span><span class="comment"> (</span><span class="comment">c</span><span class="comment">) 2013-2014 </span><span class="comment">released</span> <span class="comment">Microchip</span> <span class="comment">Technology</span> <span class="comment">Inc</span><span class="comment">.</span>  <span class="comment">All</span> <span class="comment">rights</span> <span class="comment">reserved</span><span class="comment">.</span>
 27 
 28 <span class="comment">Microchip</span> <span class="comment">licenses</span> <span class="comment">to</span> <span class="comment">you</span> <span class="comment">the</span> <span class="comment">right</span> <span class="comment">to</span> <span class="comment">use</span><span class="comment">, </span><span class="comment">modify</span><span class="comment">, </span><span class="comment">copy</span> <span class="comment">and</span> <span class="comment">distribute</span>
 29 <span class="comment">Software</span> <span class="comment">only</span> <span class="comment">when</span> <span class="comment">embedded</span> <span class="comment">on</span> <span class="comment">a</span> <span class="comment">Microchip</span> <span class="comment">microcontroller</span> <span class="comment">or</span> <span class="comment">digital</span> <span class="comment">signal</span>
 30 <span class="comment">controller</span> <span class="comment">that</span> <span class="comment">is</span> <span class="comment">integrated</span> <span class="comment">into</span> <span class="comment">your</span> <span class="comment">product</span> <span class="comment">or</span> <span class="comment">third</span> <span class="comment">party</span> <span class="comment">product</span>
 31 <span class="comment">(</span><span class="comment">pursuant</span> <span class="comment">to</span> <span class="comment">the</span> <span class="comment">sublicense</span> <span class="comment">terms</span> <span class="comment">in</span> <span class="comment">the</span> <span class="comment">accompanying</span> <span class="comment">license</span> <span class="comment">agreement</span><span class="comment">)</span><span class="comment">.</span>
 32 
 33 <span class="comment">You</span> <span class="comment">should</span> <span class="comment">refer</span> <span class="comment">to</span> <span class="comment">the</span> <span class="comment">license</span> <span class="comment">agreement</span> <span class="comment">accompanying</span> <span class="comment">this</span> <span class="comment">Software</span> <span class="comment">for</span>
 34 <span class="comment">additional</span> <span class="comment">information</span> <span class="comment">regarding</span> <span class="comment">your</span> <span class="comment">rights</span> <span class="comment">and</span> <span class="comment">obligations</span><span class="comment">.</span>
 35 
 36 <span class="comment">SOFTWARE</span> <span class="comment">AND</span> <span class="comment">DOCUMENTATION</span> <span class="comment">ARE</span> <span class="comment">PROVIDED</span><span class="comment"> &quot;</span><span class="comment">AS</span> <span class="comment">IS</span><span class="comment">&quot; </span><span class="comment">WITHOUT</span> <span class="comment">WARRANTY</span> <span class="comment">OF</span> <span class="comment">ANY</span> <span class="comment">KIND</span><span class="comment">,</span>
 37 <span class="comment">EITHER</span> <span class="comment">EXPRESS</span> <span class="comment">OR</span> <span class="comment">IMPLIED</span><span class="comment">, </span><span class="comment">INCLUDING</span> <span class="comment">WITHOUT</span> <span class="comment">LIMITATION</span><span class="comment">, </span><span class="comment">ANY</span> <span class="comment">WARRANTY</span> <span class="comment">OF</span>
 38 <span class="comment">MERCHANTABILITY</span><span class="comment">, </span><span class="comment">TITLE</span><span class="comment">, </span><span class="comment">NON</span><span class="comment">-</span><span class="comment">INFRINGEMENT</span> <span class="comment">AND</span> <span class="comment">FITNESS</span> <span class="comment">FOR</span> <span class="comment">A</span> <span class="comment">PARTICULAR</span> <span class="comment">PURPOSE</span><span class="comment">.</span>
 39 <span class="comment">IN</span> <span class="comment">NO</span> <span class="comment">EVENT</span> <span class="comment">SHALL</span> <span class="comment">MICROCHIP</span> <span class="comment">OR</span> <span class="comment">ITS</span> <span class="comment">LICENSORS</span> <span class="comment">BE</span> <span class="comment">LIABLE</span> <span class="comment">OR</span> <span class="comment">OBLIGATED</span> <span class="comment">UNDER</span>
 40 <span class="comment">CONTRACT</span><span class="comment">, </span><span class="comment">NEGLIGENCE</span><span class="comment">, </span><span class="comment">STRICT</span> <span class="comment">LIABILITY</span><span class="comment">, </span><span class="comment">CONTRIBUTION</span><span class="comment">, </span><span class="comment">BREACH</span> <span class="comment">OF</span> <span class="comment">WARRANTY</span><span class="comment">, </span><span class="comment">OR</span>
 41 <span class="comment">OTHER</span> <span class="comment">LEGAL</span> <span class="comment">EQUITABLE</span> <span class="comment">THEORY</span> <span class="comment">ANY</span> <span class="comment">DIRECT</span> <span class="comment">OR</span> <span class="comment">INDIRECT</span> <span class="comment">DAMAGES</span> <span class="comment">OR</span> <span class="comment">EXPENSES</span>
 42 <span class="comment">INCLUDING</span> <span class="comment">BUT</span> <span class="comment">NOT</span> <span class="comment">LIMITED</span> <span class="comment">TO</span> <span class="comment">ANY</span> <span class="comment">INCIDENTAL</span><span class="comment">, </span><span class="comment">SPECIAL</span><span class="comment">, </span><span class="comment">INDIRECT</span><span class="comment">, </span><span class="comment">PUNITIVE</span> <span class="comment">OR</span>
 43 <span class="comment">CONSEQUENTIAL</span> <span class="comment">DAMAGES</span><span class="comment">, </span><span class="comment">LOST</span> <span class="comment">PROFITS</span> <span class="comment">OR</span> <span class="comment">LOST</span> <span class="comment">DATA</span><span class="comment">, </span><span class="comment">COST</span> <span class="comment">OF</span> <span class="comment">PROCUREMENT</span> <span class="comment">OF</span>
 44 <span class="comment">SUBSTITUTE</span> <span class="comment">GOODS</span><span class="comment">, </span><span class="comment">TECHNOLOGY</span><span class="comment">, </span><span class="comment">SERVICES</span><span class="comment">, </span><span class="comment">OR</span> <span class="comment">ANY</span> <span class="comment">CLAIMS</span> <span class="comment">BY</span> <span class="comment">THIRD</span> <span class="comment">PARTIES</span>
 45 <span class="comment">(</span><span class="comment">INCLUDING</span> <span class="comment">BUT</span> <span class="comment">NOT</span> <span class="comment">LIMITED</span> <span class="comment">TO</span> <span class="comment">ANY</span> <span class="comment">DEFENSE</span> <span class="comment">THEREOF</span><span class="comment">), </span><span class="comment">OR</span> <span class="comment">OTHER</span> <span class="comment">SIMILAR</span> <span class="comment">COSTS</span><span class="comment">.</span>
 46  <span class="comment">******************************************************************************</span><span class="comment">*/</span>
 47 <span class="comment">//</span> <span class="comment">DOM</span><span class="comment">-</span><span class="comment">IGNORE</span><span class="comment">-</span><span class="comment">END</span>
 48 
 49 
 50 <span class="comment">//</span><span class="comment"> *****************************************************************************</span>
 51 <span class="comment">//</span><span class="comment"> *****************************************************************************</span>
 52 <span class="comment">//</span> <span class="comment">Section</span><span class="comment">: </span><span class="comment">Included</span> <span class="comment">Files</span> 
 53 <span class="comment">//</span><span class="comment"> *****************************************************************************</span>
 54 <span class="comment">//</span><span class="comment"> *****************************************************************************</span>
 55 
 56 <span class="preprocessor">#</span><span class="preprocessor">include</span> <span class="string">&quot;app.h&quot;</span>
 57 <span class="preprocessor">#</span><span class="preprocessor">include</span> <span class="string">&quot;bno055.h&quot;</span>
 58 <span class="preprocessor">#</span><span class="preprocessor">include</span> <span class="string">&quot;bno055_support.h&quot;</span>
 59 <span class="preprocessor">#</span><span class="preprocessor">include</span> <span class="string">&quot;Mc32_I2cUtilCCS.h&quot;</span>
 60 <span class="preprocessor">#</span><span class="preprocessor">include</span> <span class="string">&quot;Mc32_serComm.h&quot;</span>
 61 <span class="preprocessor">#</span><span class="preprocessor">include</span> <span class="string">&quot;Mc32_sdFatGest.h&quot;</span>
 62 <span class="preprocessor">#</span><span class="preprocessor">include</span> <span class="string">&quot;Mc32_PressAdc.h&quot;</span>
 63 <span class="preprocessor">#</span><span class="preprocessor">include</span> <span class="string">&quot;Mc32Debounce.h&quot;</span>
 64 <span class="preprocessor">#</span><span class="preprocessor">include</span> <span class="string">&lt;stdio.h&gt;</span>
 65 
 66 <span class="comment">//</span><span class="comment"> *****************************************************************************</span>
 67 <span class="comment">//</span><span class="comment"> *****************************************************************************</span>
 68 <span class="comment">//</span> <span class="comment">Section</span><span class="comment">: </span><span class="comment">Global</span> <span class="comment">Data</span> <span class="comment">Definitions</span>
 69 <span class="comment">//</span><span class="comment"> *****************************************************************************</span>
 70 <span class="comment">//</span><span class="comment"> *****************************************************************************</span>
 71 <span class="comment">/*</span> <span class="comment">Switch</span> <span class="comment">descriptor</span> <span class="comment">*/</span>
 72 <span class="ST1">S_SwitchDescriptor</span> switchDescr;
 73 <span class="comment">//</span><span class="comment"> *****************************************************************************</span>
 74 <span class="comment">/*</span> <span class="comment">Application</span> <span class="comment">Data</span>
 75 
 76   <span class="comment">Summary</span><span class="comment">:</span>
 77     <span class="comment">Holds</span> <span class="comment">application</span> <span class="comment">data</span>
 78 
 79   <span class="comment">Description</span><span class="comment">:</span>
 80     <span class="comment">This</span> <span class="comment">structure</span> <span class="comment">holds</span> <span class="comment">the</span> <span class="comment">application</span><span class="comment">&#39;</span><span class="comment">s</span> <span class="comment">data</span><span class="comment">.</span>
 81 
 82   <span class="comment">Remarks</span><span class="comment">:</span>
 83     <span class="comment">This</span> <span class="comment">structure</span> <span class="comment">should</span> <span class="comment">be</span> <span class="comment">initialized</span> <span class="comment">by</span> <span class="comment">the</span> <span class="comment">APP_Initialize</span> <span class="comment">function</span><span class="comment">.</span>
 84     
 85     <span class="comment">Application</span> <span class="comment">strings</span> <span class="comment">and</span> <span class="comment">buffers</span> <span class="comment">are</span> <span class="comment">be</span> <span class="comment">defined</span> <span class="comment">outside</span> <span class="comment">this</span> <span class="comment">structure</span><span class="comment">.</span>
 86 <span class="comment">*/</span>
 87 
 88 <span class="ST1">APP_DATA</span> appData;
 89 <span class="ST1">TIMER_DATA</span> timerData;
 90 
 91 <span class="comment">//</span><span class="comment"> *****************************************************************************</span>
 92 <span class="comment">//</span><span class="comment"> *****************************************************************************</span>
 93 <span class="comment">//</span> <span class="comment">Section</span><span class="comment">: </span><span class="comment">Application</span> <span class="comment">Callback</span> <span class="comment">Functions</span>
 94 <span class="comment">//</span><span class="comment"> *****************************************************************************</span>
 95 <span class="comment">//</span><span class="comment"> *****************************************************************************</span>
 96 <span class="literal">void</span> <span class="ST2">MainTimer_callback</span>(){
 97     <span class="comment">/*</span> <span class="comment">Increment</span> <span class="comment">delay</span> <span class="comment">timer</span> <span class="comment">*/</span>
 98     timerData.<span class="ST3">TmrCnt</span> ++;
 99 }
100 
101 <span class="literal">void</span> <span class="ST2">DisplayTimer_callback</span>()
102 {
103     <span class="comment">/*</span> <span class="comment">Increment</span> <span class="comment">utility</span> <span class="comment">timers</span> <span class="comment">*/</span>
104     timerData.<span class="ST3">TmrDisplay</span> ++;
105     timerData.<span class="ST3">TmrMeas</span> ++;
106     timerData.<span class="ST3">TmrTickFlag</span> = <span class="pragma-omp-keyword-directive">true</span>;
107     <span class="comment">/*</span> <span class="comment">If</span> <span class="comment">button</span> <span class="comment">is</span> <span class="comment">pressed</span><span class="comment">, </span><span class="comment">count</span> <span class="comment">pressed</span> <span class="comment">time</span> <span class="comment">*/</span>
108     <span class="preprocessor">if</span>(timerData.<span class="ST3">flagCountBtnPressed</span>){
109         timerData.<span class="ST3">TmrBtnPressed</span>++;
110     }
111      <span class="comment">/*</span> <span class="comment">Do</span> <span class="comment">debounce</span> <span class="comment">every</span><span class="comment"> 10 </span><span class="comment">ms</span> <span class="comment">*/</span>
112      DoDebounce(&amp;switchDescr, <span class="pragma-omp-keyword-directive">ButtonMFStateGet</span>());
113     <span class="comment">/*</span> <span class="comment">Start</span> <span class="comment">a</span> <span class="comment">measure</span> <span class="comment">set</span> <span class="comment">each</span><span class="comment"> 90</span><span class="comment">ms</span> <span class="comment">*/</span>        
114     <span class="preprocessor">if</span> ( ( timerData.<span class="ST3">TmrMeas</span> % <span class="string">9</span> ) == <span class="string">0</span>)
115         timerData.<span class="ST3">measTodoFlag</span> = <span class="pragma-omp-keyword-directive">true</span>;
116 }
117 <span class="comment">/*</span> <span class="comment">TODO</span><span class="comment">:  </span><span class="comment">Add</span> <span class="comment">any</span> <span class="comment">necessary</span> <span class="comment">callback</span> <span class="comment">functions</span><span class="comment">.</span>
118 <span class="comment">*/</span>
119 
120 <span class="comment">//</span><span class="comment"> *****************************************************************************</span>
121 <span class="comment">//</span><span class="comment"> *****************************************************************************</span>
122 <span class="comment">//</span> <span class="comment">Section</span><span class="comment">: </span><span class="comment">Application</span> <span class="comment">Local</span> <span class="comment">Functions</span>
123 <span class="comment">//</span><span class="comment"> *****************************************************************************</span>
124 <span class="comment">//</span><span class="comment"> *****************************************************************************</span>
125 
126 
127 <span class="comment">/*</span> <span class="comment">TODO</span><span class="comment">:  </span><span class="comment">Add</span> <span class="comment">any</span> <span class="comment">necessary</span> <span class="comment">local</span> <span class="comment">functions</span><span class="comment">.</span>
128 <span class="comment">*/</span>
129 
130 
131 <span class="comment">//</span><span class="comment"> *****************************************************************************</span>
132 <span class="comment">//</span><span class="comment"> *****************************************************************************</span>
133 <span class="comment">//</span> <span class="comment">Section</span><span class="comment">: </span><span class="comment">Application</span> <span class="comment">Initialization</span> <span class="comment">and</span> <span class="comment">State</span> <span class="comment">Machine</span> <span class="comment">Functions</span>
134 <span class="comment">//</span><span class="comment"> *****************************************************************************</span>
135 <span class="comment">//</span><span class="comment"> *****************************************************************************</span>
136 
137 <span class="comment">/**</span><span class="comment">*****************************************************************************</span>
138   <span class="comment">Function</span><span class="comment">:</span>
139     <span class="comment">void</span> <span class="comment">APP_Initialize</span><span class="comment"> ( </span><span class="comment">void</span><span class="comment"> )</span>
140 
141   <span class="comment">Remarks</span><span class="comment">:</span>
142     <span class="comment">See</span> <span class="comment">prototype</span> <span class="comment">in</span> <span class="comment">app</span><span class="comment">.</span><span class="comment">h</span><span class="comment">.</span>
143  <span class="comment">*/</span>
144 
145 <span class="literal">void</span> <span class="ST2">APP_Initialize</span> ( <span class="literal">void</span> )
146 {
147     <span class="comment">/*</span> <span class="comment">Place</span> <span class="comment">the</span> <span class="comment">App</span> <span class="comment">state</span> <span class="comment">machine</span> <span class="comment">in</span> <span class="comment">its</span> <span class="comment">initial</span> <span class="comment">state</span><span class="comment">.</span> <span class="comment">*/</span>
148     appData.<span class="ST3">state</span> = APP_STATE_INIT;
149     <span class="comment">/*</span> <span class="comment">Init</span> <span class="comment">all</span> <span class="comment">counters</span> <span class="comment">and</span> <span class="comment">flags</span> <span class="comment">*/</span>
150     timerData.<span class="ST3">mainTmrCnt</span> = <span class="string">0</span>;
151     timerData.<span class="ST3">TmrCnt</span> = <span class="string">0</span>;
152     timerData.<span class="ST3">TmrTickFlag</span> = <span class="pragma-omp-keyword-directive">false</span>; 
153     timerData.<span class="ST3">TmrDisplay</span> = <span class="string">0</span>;
154     timerData.<span class="ST3">measTodoFlag</span> = <span class="pragma-omp-keyword-directive">false</span>;
155     timerData.<span class="ST3">flagCountBtnPressed</span> = <span class="pragma-omp-keyword-directive">false</span>;
156     timerData.<span class="ST3">TmrBtnPressed</span> = <span class="string">0</span>;
157         
158     <span class="comment">/*</span> <span class="comment">Hold</span> <span class="comment">the</span> <span class="comment">device</span> <span class="comment">on</span> <span class="comment">*/</span>
159     <span class="pragma-omp-keyword-directive">PwrHoldOn</span>();
160     <span class="comment">/*</span> <span class="comment">Peripherals</span> <span class="comment">init</span> <span class="comment">*/</span>
161     DRV_TMR0_Start();
162     DRV_TMR1_Start();
163     i2c_init(<span class="string">1</span>);
164     Press_InitADC();
165     
166     <span class="comment">/*</span> <span class="comment">System</span> <span class="comment">ON</span> <span class="comment">display</span> <span class="comment">*/</span>
167     <span class="pragma-omp-keyword-directive">LED_BOn</span>();
168     BNO055_delay_msek(<span class="string">500</span>);
169     <span class="pragma-omp-keyword-directive">LED_BOff</span>();
170     
171     <span class="comment">/*</span> <span class="comment">Reset</span> <span class="comment">IMU</span> <span class="comment">*/</span>
172     <span class="pragma-omp-keyword-directive">RstImuOff</span>();
173     BNO055_delay_msek(<span class="string">100</span>);
174     <span class="pragma-omp-keyword-directive">RstImuOn</span>();
175     BNO055_delay_msek(<span class="string">100</span>);
176     
177     <span class="comment">/*</span> <span class="comment">Demuliplexer</span> <span class="comment">config</span> <span class="comment">*/</span>
178     <span class="pragma-omp-keyword-directive">DemulCBOff</span>();
179     <span class="pragma-omp-keyword-directive">DemulCCOn</span>();
180     
181     <span class="comment">/*</span> <span class="comment">Enable</span><span class="comment"> 5</span><span class="comment">V</span> <span class="comment">regulator</span> <span class="comment">*/</span>
182     <span class="pragma-omp-keyword-directive">EN_5VOn</span>();
183     
184     
185 }
186 
187 
188 <span class="comment">/**</span><span class="comment">****************************************************************************</span>
189   <span class="comment">Function</span><span class="comment">:</span>
190     <span class="comment">void</span> <span class="comment">APP_Tasks</span><span class="comment"> ( </span><span class="comment">void</span><span class="comment"> )</span>
191 
192   <span class="comment">Remarks</span><span class="comment">:</span>
193     <span class="comment">See</span> <span class="comment">prototype</span> <span class="comment">in</span> <span class="comment">app</span><span class="comment">.</span><span class="comment">h</span><span class="comment">.</span>
194  <span class="comment">*/</span>
195 
196 <span class="literal">void</span> <span class="ST2">APP_Tasks</span> ( <span class="literal">void</span> )
197 {
198     <span class="comment">/*</span> <span class="comment">Local</span> <span class="comment">bno055</span> <span class="comment">data</span> <span class="comment">*/</span>
199     <span class="ST1">s_bno055_data</span> <span class="ST4">bno055_local_data</span>;  
200     <span class="literal">static</span> <span class="pragma-omp-keyword-directive">bool</span> Hold = <span class="pragma-omp-keyword-directive">false</span>;
201     <span class="literal">static</span> <span class="pragma-omp-keyword-directive">uint8_t</span> flagMeas = <span class="pragma-omp-keyword-directive">false</span>;
202      <span class="comment">/*</span> <span class="comment">Check</span> <span class="comment">the</span> <span class="comment">application</span><span class="comment">&#39;</span><span class="comment">s</span> <span class="comment">current</span> <span class="comment">state</span><span class="comment">.</span> <span class="comment">*/</span>
203     <span class="preprocessor">switch</span> ( appData.<span class="ST3">state</span> )
204     {
205         <span class="comment">/*</span> <span class="comment">Application</span><span class="comment">&#39;</span><span class="comment">s</span> <span class="comment">initial</span> <span class="comment">state</span><span class="comment">.</span> <span class="comment">*/</span>
206         <span class="preprocessor">case</span> APP_STATE_INIT:
207         {
208             <span class="comment">//</span> <span class="comment">Init</span> <span class="comment">delay</span>
209             BNO055_delay_msek(<span class="string">500</span>);
210             <span class="comment">//</span> <span class="comment">Init</span> <span class="comment">and</span> <span class="comment">Measure</span> <span class="comment">set</span>
211             bno055_init_readout();
212             <span class="comment">/*</span> <span class="comment">go</span> <span class="comment">to</span> <span class="comment">service</span> <span class="comment">task</span> <span class="comment">*/</span>
213             appData.<span class="ST3">state</span> = APP_STATE_LOGGING;
214             <span class="comment">/*</span> <span class="comment">Init</span> <span class="comment">ltime</span> <span class="comment">counter</span> <span class="comment">*/</span>
215             timerData.<span class="ST3">ltime</span> = <span class="string">0</span>;
216             <span class="comment">/*</span> <span class="comment">Init</span> <span class="comment">first</span> <span class="comment">measure</span> <span class="comment">flag</span> <span class="comment">*/</span>
217             flagMeas = <span class="pragma-omp-keyword-directive">FLAG_MEAS_OFF</span>;
218             <span class="preprocessor">break</span>;
219         }
220 
221         <span class="preprocessor">case</span> APP_STATE_LOGGING:
222         {    
223             <span class="comment">/*</span> <span class="comment">Display</span> <span class="comment">period</span> <span class="comment">*/</span>
224             <span class="preprocessor">if</span>(timerData.<span class="ST3">TmrDisplay</span> &gt;= <span class="string">320</span>)
225                 timerData.<span class="ST3">TmrDisplay</span> = <span class="string">0</span>;
226             <span class="comment">//</span><span class="comment"> --- </span><span class="comment">Display</span> <span class="comment">LED</span><span class="comment"> ---</span>
227             <span class="preprocessor">if</span>((timerData.<span class="ST3">TmrDisplay</span> &lt;= <span class="string">1</span>)&amp;&amp;(sd_getState() != APP_MOUNT_DISK))
228                 <span class="pragma-omp-keyword-directive">LED_GOn</span>();
229             <span class="preprocessor">else</span>
230                 <span class="pragma-omp-keyword-directive">LED_GOff</span>();
231 
232             <span class="preprocessor">if</span>((timerData.<span class="ST3">measTodoFlag</span> == <span class="pragma-omp-keyword-directive">true</span> )&amp;&amp;(sd_getState() == APP_IDLE))
233             {
234                 <span class="comment">/*</span> <span class="comment">BNO055</span> <span class="comment">Read</span> <span class="comment">all</span> <span class="comment">important</span> <span class="comment">info</span> <span class="comment">routine</span> <span class="comment">*/</span>
235                 <span class="ST4">bno055_local_data</span>.<span class="ST3">comres</span> = bno055_read_routine(&amp;<span class="ST4">bno055_local_data</span>);
236                 <span class="comment">/*</span> <span class="comment">Delta</span> <span class="comment">time</span> <span class="comment">*/</span>
237                 <span class="ST4">bno055_local_data</span>.<span class="ST3">d_time</span> = timerData.<span class="ST3">TmrMeas</span> - timerData.<span class="ST3">ltime</span>;
238                 <span class="comment">/*</span> <span class="comment">Pressure</span> <span class="comment">measure</span> <span class="comment">*/</span>
239                 <span class="ST4">bno055_local_data</span>.<span class="ST3">pressure</span> = Press_readPressure();
240                 <span class="comment">/*</span> <span class="comment">Flag</span> <span class="comment">measure</span> <span class="comment">value</span> <span class="comment">*/</span>
241                 <span class="ST4">bno055_local_data</span>.<span class="ST3">flagImportantMeas</span> = flagMeas;
242                 <span class="comment">/*</span> <span class="comment">Display</span> <span class="comment">value</span> <span class="comment">via</span> <span class="comment">UART</span> <span class="comment">*/</span>
243                 <span class="comment">//</span><span class="comment">serDisplayValues</span><span class="comment">(&amp;</span><span class="comment">bno055_local_data</span><span class="comment">);</span>
244                 <span class="comment">/*</span> <span class="comment">Write</span> <span class="comment">value</span> <span class="comment">to</span> <span class="comment">sdCard</span> <span class="comment">*/</span>
245                 sd_BNO_scheduleWrite(&amp;<span class="ST4">bno055_local_data</span>);
246                 <span class="comment">/*</span> <span class="comment">Reset</span> <span class="comment">measure</span> <span class="comment">flag</span> <span class="comment">*/</span>
247                 <span class="preprocessor">if</span>(flagMeas == <span class="pragma-omp-keyword-directive">FLAG_MEAS_ON</span>){
248                     <span class="comment">/*</span> <span class="comment">Rest</span> <span class="comment">important</span> <span class="comment">measure</span> <span class="comment">flag</span> <span class="comment">*/</span>
249                     flagMeas = <span class="pragma-omp-keyword-directive">FLAG_MEAS_OFF</span>;
250                     <span class="pragma-omp-keyword-directive">LED_BOff</span>();
251                 }
252                 <span class="comment">/*</span> <span class="comment">Reset</span> <span class="comment">measure</span> <span class="comment">flag</span> <span class="comment">*/</span>
253                 timerData.<span class="ST3">measTodoFlag</span> = <span class="pragma-omp-keyword-directive">false</span>;
254                 <span class="comment">/*</span> <span class="comment">Update</span> <span class="comment">last</span> <span class="comment">time</span> <span class="comment">counter</span> <span class="comment">*/</span>
255                 timerData.<span class="ST3">ltime</span> = timerData.<span class="ST3">TmrMeas</span>;
256             }
257             <span class="preprocessor">else</span>
258             {
259                 <span class="comment">/*</span> <span class="comment">No</span> <span class="comment">comm</span><span class="comment">, </span><span class="comment">so</span> <span class="comment">no</span> <span class="comment">error</span> <span class="comment">*/</span>
260                 <span class="ST4">bno055_local_data</span>.<span class="ST3">comres</span> = <span class="string">0</span>;
261             }
262             
263             <span class="comment">/*</span> <span class="comment">If</span> <span class="comment">error</span> <span class="comment">detected</span><span class="comment"> : </span><span class="comment">error</span> <span class="comment">LED</span> <span class="comment">*/</span>
264             <span class="preprocessor">if</span>((<span class="ST4">bno055_local_data</span>.<span class="ST3">comres</span> != <span class="string">0</span>)||(sd_getState() == APP_MOUNT_DISK))
265                 <span class="pragma-omp-keyword-directive">LED_ROn</span>();
266             <span class="preprocessor">else</span>
267                 <span class="pragma-omp-keyword-directive">LED_ROff</span>();
268             
269             <span class="comment">/*</span><span class="comment"> --- </span><span class="comment">SD</span> <span class="comment">FAT</span> <span class="comment">routine</span><span class="comment"> --- </span><span class="comment">*/</span>
270             sd_fat_task();
271                
272             <span class="comment">/*</span> <span class="comment">Button</span> <span class="comment">management</span><span class="comment"> : </span><span class="comment">if</span> <span class="comment">rising</span> <span class="comment">edge</span> <span class="comment">detected</span> <span class="comment">*/</span>
273             <span class="preprocessor">if</span>(((<span class="pragma-omp-keyword-directive">ButtonMFStateGet</span>()))||(Hold == <span class="pragma-omp-keyword-directive">true</span>))
274             {
275                 <span class="comment">/*</span> <span class="comment">Hold</span> <span class="comment">until</span> <span class="comment">falling</span> <span class="comment">edge</span> <span class="comment">*/</span>
276                 Hold = <span class="pragma-omp-keyword-directive">true</span>;
277                 <span class="comment">/*</span> <span class="comment">Start</span> <span class="comment">counting</span> <span class="comment">pressed</span> <span class="comment">time</span> <span class="comment">*/</span>
278                 timerData.<span class="ST3">flagCountBtnPressed</span> = <span class="pragma-omp-keyword-directive">true</span>;
279                 <span class="comment">/*</span> <span class="comment">If</span> <span class="comment">falling</span> <span class="comment">edge</span> <span class="comment">detected</span> <span class="comment">*/</span>
280                 <span class="preprocessor">if</span> (<span class="pragma-omp-keyword-directive">ButtonMFStateGet</span>() == <span class="string">0</span>)
281                 {
282                     <span class="comment">/*</span> <span class="comment">Reset</span> <span class="comment">flag</span> <span class="comment">and</span> <span class="comment">switchdescr</span> <span class="comment">*/</span>
283                     timerData.<span class="ST3">flagCountBtnPressed</span> = <span class="pragma-omp-keyword-directive">false</span>;
284                     DebounceClearReleased(&amp;switchDescr);
285                     <span class="comment">/*</span> <span class="comment">If</span> <span class="comment">pressed</span> <span class="comment">time</span> <span class="comment">less</span> <span class="comment">than</span> <span class="comment">power</span> <span class="comment">off</span> <span class="comment">time</span> <span class="comment">*/</span>
286                     <span class="preprocessor">if</span>((timerData.<span class="ST3">TmrBtnPressed</span> &lt;= <span class="pragma-omp-keyword-directive">TIME_POWER_OFF</span>)&amp;&amp;(sd_getState() != APP_MOUNT_DISK)){
287                         flagMeas = <span class="pragma-omp-keyword-directive">FLAG_MEAS_ON</span>;
288                         <span class="pragma-omp-keyword-directive">LED_BOn</span>();
289                     }
290                     <span class="preprocessor">else</span>{
291                         <span class="comment">/*</span> <span class="comment">Power</span> <span class="comment">off</span> <span class="comment">the</span> <span class="comment">system</span> <span class="comment">*/</span>
292                         appData.<span class="ST3">state</span> = APP_STATE_SHUTDOWN;
293                     }
294                     timerData.<span class="ST3">TmrBtnPressed</span> = <span class="string">0</span>;
295                     Hold = <span class="pragma-omp-keyword-directive">false</span>;
296                 }
297             }
298             
299            <span class="preprocessor">break</span>;
300         }
301         <span class="preprocessor">case</span> APP_STATE_SHUTDOWN:
302         {
303             <span class="comment">/*</span> <span class="comment">Display</span> <span class="comment">shutting</span> <span class="comment">off</span> <span class="comment">mode</span> <span class="comment">*/</span>
304             <span class="pragma-omp-keyword-directive">LED_BOff</span>();
305             <span class="pragma-omp-keyword-directive">LED_GOff</span>();
306             <span class="pragma-omp-keyword-directive">LED_ROn</span>();
307             
308             <span class="comment">/*</span> <span class="comment">If</span> <span class="comment">and</span> <span class="comment">SD</span> <span class="comment">card</span> <span class="comment">is</span> <span class="comment">mounted</span> <span class="comment">*/</span>
309             <span class="preprocessor">if</span>(sd_getState() != APP_MOUNT_DISK){
310                 <span class="comment">/*</span> <span class="comment">Wait</span> <span class="comment">until</span> <span class="comment">SD</span> <span class="comment">availaible</span> <span class="comment">*/</span>
311                 <span class="preprocessor">while</span>(sd_getState() != APP_IDLE){
312                     <span class="comment">/*</span> <span class="comment">SD</span> <span class="comment">FAT</span> <span class="comment">routine</span> <span class="comment">*/</span>
313                     sd_fat_task();
314                 }
315                 <span class="comment">/*</span> <span class="comment">Unmount</span> <span class="comment">disk</span> <span class="comment">*/</span>
316                 sd_setState(APP_UNMOUNT_DISK);
317                 <span class="comment">/*</span> <span class="comment">Wait</span> <span class="comment">until</span> <span class="comment">unmounted</span><span class="comment">*/</span>
318                 <span class="preprocessor">while</span>(sd_getState() != APP_IDLE){
319                     sd_fat_task();
320                 }
321             }
322             
323             <span class="comment">/*</span> <span class="comment">turn</span> <span class="comment">off</span> <span class="comment">the</span> <span class="comment">device</span> <span class="comment">*/</span>
324             <span class="pragma-omp-keyword-directive">PwrHoldOff</span>();
325             
326             <span class="preprocessor">break</span>;
327         }
328         
329         <span class="comment">/*</span> <span class="comment">TODO</span><span class="comment">: </span><span class="comment">implement</span> <span class="comment">your</span> <span class="comment">application</span> <span class="comment">state</span> <span class="comment">machine</span><span class="comment">.</span><span class="comment">*/</span>
330         
331 
332         <span class="comment">/*</span> <span class="comment">The</span> <span class="comment">default</span> <span class="comment">state</span> <span class="comment">should</span> <span class="comment">never</span> <span class="comment">be</span> <span class="comment">executed</span><span class="comment">.</span> <span class="comment">*/</span>
333         <span class="preprocessor">default</span>:
334         {
335             <span class="comment">/*</span> <span class="comment">TODO</span><span class="comment">: </span><span class="comment">Handle</span> <span class="comment">error</span> <span class="comment">in</span> <span class="comment">application</span><span class="comment">&#39;</span><span class="comment">s</span> <span class="comment">state</span> <span class="comment">machine</span><span class="comment">.</span> <span class="comment">*/</span>
336             <span class="preprocessor">break</span>;
337         }
338     }
339 }
340 
341 <span class="literal">void</span> <span class="ST2">App_resetMeasFlag</span>( <span class="literal">void</span> )
342 {
343     timerData.<span class="ST3">measTodoFlag</span> = <span class="pragma-omp-keyword-directive">false</span>;
344 }
345  
346 
347 <span class="comment">/**</span><span class="comment">*****************************************************************************</span>
348  <span class="comment">End</span> <span class="comment">of</span> <span class="comment">File</span>
349  <span class="comment">*/</span>
350 
</pre></body>
</html>
